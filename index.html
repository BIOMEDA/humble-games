<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <title>Humble Games</title>

    <link rel="stylesheet" href="normalize.css">
    <style>
    body {
        background: url(img/bg.png);
        text-align: center;
        color: #fff;
        text-shadow: 0 2px 4px hsla(0, 0%, 0%, 0.4);
    }

    a {
        color: #5c7f1a;
    }

    input {
        display: block;
        width: 300px;
        margin: 1em  auto;
        padding: 7px 5px;
        border: 2px solid #5c7f1a;
        border-radius: 4px;
        box-shadow: 0 0 2px 1px #5c7f1a;
    }

    li {
        display: inline-block;
        margin-right: 15px;
    }

    li > .active {
        /* @TODO */
        background: red;
    }

    span,
    iframe.shown {
        display: inline-block;
        width: 550px;
        height: 264px;
        opacity: 1;
    }

    /*
     I don't see anything wrong with using !important here, deal with it
     (•_•)
     ( •_•)>¬■-■
     (¬■_■)
    */
    [hidden] {
        display: none !important;
    }

    span {
        background: no-repeat center center url(img/loader.gif);
        opacity: .3;
    }

    iframe {
        width: 0;
        height: 0;
        border: 0;
        opacity: 0;
        -webkit-transition: opacity .3s ease-in-out;
                transition: opacity .3s ease-in-out;
    }

    footer {
        margin: 30px 0;
    }
    </style>
</head>
<body>
    <h1>All games from <a href="http://humblebundle.com">humblebundle.com</a></h1>
    <p>All your games are stored on your <a href="https://www.humblebundle.com/home">humble bundle account</a>. Feel free to <a href="https://github.com/calvein/humble-games/">edit this list</a>.</p>
    <input autofocus placeholder="e.g: &quot;Trine&quot;">
    <ul class="filters">
        <li><a href="#windows"><img src="img/windows.png" alt="windows"></a>
        <li><a href="#linux"><img src="img/linux.png" alt="linux"></a>
        <li><a href="#mac"><img src="img/mac.png" alt="mac"></a>
        <li><a href="#android"><img src="img/android.png" alt="android"></a>
        <li><a href="#audio"><img src="img/audio.png" alt="audio"></a>
    </ul>

    <main></main>

    <footer>Thanks to <strong></strong> for their contributions.</footer>

    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
    <script src="games.js"></script>
    <script>
    $(function() {
        // Add spans placeholders for the lazy-load
        var $container = $('main')
        games.forEach(function(game) {
            $container.append($('<span>').data(game))
        })

        // The spans which will be replaced by the iframes
        var $gamesPlaceholders = $('span', $container)
          , $gamesElements = $('span, iframe', $container)
          , url = 'http://www.humblebundle.com/store/product/'
        /**
         * Replace a placeholder by an iframe
         * @param  {jQel}  $placeholder  The placeholder which will be replaced
         */
          , loadIframe = function($placeholder) {
            var $iframe = $('<iframe>')
                .attr('src', url + $placeholder.data('url'))
                .data($placeholder.data())

            $placeholder.data('isLoading', true)

            $iframe.on('load', function() {
                $iframe
                    .addClass('shown')
                    .prop('hidden', $placeholder.prop('hidden'))

                // Remove the placeholder
                $placeholder.remove()
                // Rebuild the placeholders and verify if they are all transformed to iframes
                $gamesPlaceholders = $('span', $container)
                $gamesElements = $('span, iframe', $container)

                if (!$gamesPlaceholders.length) {
                    window.off('scroll')
                }
            })

            // Insert the iframe
            $placeholder.before($iframe)
        }
        /**
         * Detect if an element is in the viewport
         * @param  {Node}     el  The element which is detected
         * @return {boolean}      True if the element is in the viewport
         */
          , elementInViewport = function(el) {
            var rect = el.getBoundingClientRect()

            return (
                rect.top  >= 0 &&
                rect.left >= 0 &&
                rect.top  <= (window.innerHeight || document.documentElement.clientHeight)
            )
        }
        /**
         * Function called each time the user scroll, it detect if the elements are in the viewport
         * and if so replace them with the corresponding iframe
         */
          ,  processScroll = function() {
            $gamesPlaceholders.each(function(i, placeholder) {
                var $placeholder = $(placeholder)
                console.log($gamesPlaceholders.length, elementInViewport(placeholder), !placeholder.hidden, !$placeholder.data('isLoading'))
                if (elementInViewport(placeholder) && !placeholder.hidden && !$placeholder.data('isLoading')) {
                    loadIframe($placeholder)
                }
            })
        }

        processScroll()
        $(window).on('scroll', processScroll)

        // On search
        $('input').on('input', function() {
            var value = this.value
            $gamesElements.each(function(i, placeholder) {
                var $placeholder = $(placeholder)
                  , isShown = true
                if (new RegExp(value, 'i').test($placeholder.data('url')))
                    isShown = false
                else if (new RegExp(value, 'i').test($placeholder.data('description')))
                    isShown = false
                else if (new RegExp(value, 'i').test($placeholder.data('name')))
                    isShown = false
                else if (new RegExp(value, 'i').test($placeholder.data('developer')))
                    isShown = false

                $placeholder.prop('hidden', isShown)
            })
            processScroll()
        })

        // On filter by platform
        var $filters = $('.filters a')
        $filters.on('click', function() {
            e.preventDefault()
            var platform = this.hash.slice(1)

            $gamesElements.each(function(i, $placeholder) {
                a = $placeholder.data().platform[platform]
                console.log(a)
            })
            processScroll()
        })


        // Show the contributors, thanks by the way
        $.ajax('https://api.github.com/repos/calvein/humble-games/contributors')
        .done(function(response) {
            $('footer > strong').html(function() {
                return response.map(function(contributor) {
                    return $('<a>')
                        .attr('href', contributor.html_url)
                        .text(contributor.login)
                        .html()
                    }).join(', ')
            })
        })
    })
    </script>
    <script>
        var _gaq=[['_setAccount','UA-37825336-1'],['_trackPageview']];
        (function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];
        g.src=('https:'==location.protocol?'//ssl':'//www')+'.google-analytics.com/ga.js';
        s.parentNode.insertBefore(g,s)}(document,'script'));
    </script>
</body>
</html>
